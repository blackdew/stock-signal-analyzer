# 아키텍처 설계

섹터 순환 투자 전략 분석 시스템의 아키텍처 문서입니다.

## 시스템 개요

이 시스템은 한국 주식 시장의 섹터별 투자 기회를 분석하여 루브릭 기반 투자 등급을 산출합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                        Orchestrator                              │
│                    (전체 파이프라인 조율) [미구현]               │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ MarketData    │     │ Fundamental   │     │ News          │
│ Agent         │     │ Agent         │     │ Agent         │
└───────────────┘     └───────────────┘     └───────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                                ▼
                    ┌───────────────────┐
                    │  RubricEngine V2  │
                    │  (6개 카테고리)    │
                    └───────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ StockAnalyzer │     │SectorAnalyzer │     │ RankingAgent  │
│ (개별 종목)    │────▶│ (섹터 평균)    │────▶│ (최종 순위)    │
└───────────────┘     └───────────────┘     └───────────────┘
                                                    │
                                                    ▼
                                        ┌───────────────────┐
                                        │   ReportAgents    │
                                        │ Stock/Sector/     │
                                        │ Summary           │
                                        └───────────────────┘
                                                    │
                                                    ▼
                                        ┌───────────────────┐
                                        │   Report Output   │
                                        │  (최종 18개/Top3) │
                                        └───────────────────┘
```

## 에이전트 기반 설계

### 설계 원칙

1. **단일 책임**: 각 에이전트는 하나의 데이터 영역만 담당
2. **비동기 처리**: 여러 에이전트가 병렬로 데이터 수집 가능
3. **캐시 통합**: 모든 에이전트가 공통 캐시 시스템 사용
4. **확장성**: 새 에이전트 추가가 용이한 구조

### BaseAgent 추상 클래스

```python
@dataclass
class BaseAgent(ABC):
    cache: CacheManager = field(default_factory=CacheManager)

    @abstractmethod
    async def collect(self, symbols: List[str]) -> Dict[str, Any]:
        """데이터 수집 (서브클래스에서 구현)"""
        pass

    def _get_cached_or_fetch(self, cache_key, fetch_func, ttl_hours):
        """캐시 우선 조회, 미스 시 fetch"""
        pass
```

### 데이터 에이전트 구성

| 에이전트 | 역할 | 데이터 소스 | 캐시 TTL |
|----------|------|-------------|----------|
| MarketDataAgent | 시장 데이터 | FinanceDataReader | 4시간 |
| FundamentalAgent | 재무제표 | FinanceDataReader | 7일 |
| NewsAgent | 뉴스/센티먼트 | NEWS API | 24시간 |

### 분석 에이전트 구성

| 에이전트 | 역할 | 입력 | 출력 |
|----------|------|------|------|
| StockAnalyzer | 개별 종목 점수 | 데이터 에이전트 결과 | StockAnalysisResult |
| SectorAnalyzer | 섹터 점수 | StockAnalysisResult | SectorAnalysisResult |
| RankingAgent | 최종 순위 | Stock/Sector 결과 | RankingResult |

### 리포트 에이전트 구성

| 에이전트 | 역할 | 입력 | 출력 |
|----------|------|------|------|
| StockReportAgent | 종목 리포트 | StockAnalysisResult | 마크다운 파일 |
| SectorReportAgent | 섹터 리포트 | SectorAnalysisResult | 마크다운 파일 |
| SummaryAgent | 종합 리포트 | RankingResult | 마크다운 + JSON |

## 데이터 흐름

### 1단계: 데이터 수집

```
섹터 설정 (config.py)
        │
        ▼
┌─────────────────────────────────────────────┐
│ SECTORS = {                                 │
│   "반도체": ["005930", "000660", ...],      │
│   "조선": ["010140", "009540", ...],        │
│   ... (총 11개 섹터, 각 5개 종목)           │
│ }                                           │
└─────────────────────────────────────────────┘
        │
        ▼
에이전트별 병렬 수집
        │
        ▼
캐시 저장 (output/data/cache/)
```

### 2단계: 루브릭 평가 (V2)

```
MarketData ─────┐
                │
FundamentalData ┼──▶ RubricEngine V2 ──▶ RubricResult
                │         │
NewsData ───────┘         ▼
                   ┌──────────────────────────┐
                   │ total_score: 65.3        │
                   │ grade: "Buy"             │
                   │ technical: 16.25/25      │
                   │ supply: 12.5/20          │
                   │ fundamental: 12.5/20     │
                   │ market: 9.75/15          │
                   │ risk: 7.0/10             │
                   │ relative_strength: 7.5/10│
                   └──────────────────────────┘
```

### 3단계: 분석 에이전트 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│                    StockAnalyzer                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 4개 그룹 분석:                                         │  │
│  │   - KOSPI Top 10 (시총 1~10위)                        │  │
│  │   - KOSPI 11~20 (시총 11~20위)                        │  │
│  │   - KOSDAQ Top 10 (시총 1~10위)                       │  │
│  │   - 11개 섹터별 종목 (각 5개)                          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   SectorAnalyzer                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 섹터별 시가총액 가중 평균 점수 계산                     │  │
│  │ 상위 3개 섹터 선정                                      │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    RankingAgent                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 그룹별 상위 3개 선정:                                  │  │
│  │   - KOSPI Top 10 → 3개                                │  │
│  │   - KOSPI 11~20 → 3개                                 │  │
│  │   - KOSDAQ Top 10 → 3개                               │  │
│  │   - 상위 3개 섹터 → 각 3개 (9개)                       │  │
│  │                                                        │  │
│  │ 중복 제거 후 최종 18개 종목 집계                        │  │
│  │ Top 3 선정 (총점 70% + 수급 15% + 성장성 15%)          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    최종 결과                                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ final_18: 최종 선정된 18개 종목                        │  │
│  │ final_top3: 최상위 3개 종목                            │  │
│  │ top_sectors: 상위 3개 섹터                             │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 4단계: 리포트 생성

```
RankingResult
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                     Report Agents                            │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────┐ ┌─────────────────────┐            │
│ │ StockReportAgent    │ │ SectorReportAgent   │            │
│ │ ├─ 종목 분석 결과    │ │ ├─ 섹터 분석 결과   │            │
│ │ ├─ 6개 카테고리 점수 │ │ ├─ 시총 가중 평균   │            │
│ │ ├─ 판정/의견 생성    │ │ ├─ 강/약점 분석     │            │
│ │ └─ 병렬 생성        │ │ └─ 섹터 전망       │            │
│ └─────────────────────┘ └─────────────────────┘            │
│              ┌─────────────────────┐                        │
│              │ SummaryAgent        │                        │
│              │ ├─ Top 3 선정 이유   │                        │
│              │ ├─ 그룹별 종목 요약  │                        │
│              │ ├─ 최종 18개 테이블  │                        │
│              │ └─ JSON 데이터 저장  │                        │
│              └─────────────────────┘                        │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────┐
│ output/                                      │
│   ├── data/                                  │
│   │   └── analysis_YYYYMMDD.json (API용)    │
│   └── reports/                               │
│       ├── sectors/   (섹터별 리포트)         │
│       ├── stocks/    (종목별 리포트)         │
│       └── summary/   (종합리포트_YYYYMMDD)   │
└─────────────────────────────────────────────┘
```

## 루브릭 평가 시스템

### 점수 구성 V2 (100점 만점)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          RUBRIC V2 (100점)                               │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────┐ ┌─────────────────────────┐                 │
│ │ 기술적 분석 (25점)      │ │ 수급 분석 (20점)        │                 │
│ │ ├─ 추세 (6)             │ │ ├─ 외국인 (8)           │                 │
│ │ ├─ RSI (6)              │ │ ├─ 기관 (8)             │                 │
│ │ ├─ 지지/저항 (6)        │ │ └─ 거래대금 (4)         │                 │
│ │ ├─ MACD (4)             │ └─────────────────────────┘                 │
│ │ └─ ADX (3)              │ ┌─────────────────────────┐                 │
│ └─────────────────────────┘ │ 시장 환경 (15점)        │                 │
│ ┌─────────────────────────┐ │ ├─ 뉴스 (7.5)           │                 │
│ │ 펀더멘털 (20점)         │ │ ├─ 섹터모멘텀 (3.75)    │                 │
│ │ ├─ PER (4)              │ │ └─ 애널리스트 (3.75)    │                 │
│ │ ├─ PBR (4)              │ └─────────────────────────┘                 │
│ │ ├─ ROE (4)              │ ┌─────────────────────────┐                 │
│ │ ├─ 성장률 (5)           │ │ 리스크 평가 (10점)      │                 │
│ │ └─ 부채비율 (3)         │ │ ├─ 변동성 (4)           │                 │
│ └─────────────────────────┘ │ ├─ 베타 (3)             │                 │
│ ┌─────────────────────────┐ │ └─ 하방리스크 (3)       │                 │
│ │ 상대 강도 (10점)        │ └─────────────────────────┘                 │
│ │ ├─ 섹터내순위 (5)       │                                             │
│ │ └─ 시장대비알파 (5)     │                                             │
│ └─────────────────────────┘                                             │
└─────────────────────────────────────────────────────────────────────────┘
```

### 점수 구성 V1 (하위 호환, 100점 만점)

```
┌─────────────────────────────────────────────────────────┐
│                    RUBRIC V1 (100점)                     │
├─────────────────────────────────────────────────────────┤
│ ┌─────────────────────┐ ┌─────────────────────┐        │
│ │ 기술적 분석 (30점)  │ │ 수급 분석 (25점)    │        │
│ │ ├─ 추세 (10)        │ │ ├─ 외국인 (10)      │        │
│ │ ├─ RSI (10)         │ │ ├─ 기관 (10)        │        │
│ │ └─ 지지/저항 (10)   │ │ └─ 거래대금 (5)     │        │
│ └─────────────────────┘ └─────────────────────┘        │
│ ┌─────────────────────┐ ┌─────────────────────┐        │
│ │ 펀더멘털 (25점)     │ │ 시장 환경 (20점)    │        │
│ │ ├─ PER (10)         │ │ ├─ 뉴스 (10)        │        │
│ │ ├─ 성장률 (10)      │ │ ├─ 섹터모멘텀 (5)   │        │
│ │ └─ 부채비율 (5)     │ │ └─ 애널리스트 (5)   │        │
│ └─────────────────────┘ └─────────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### 등급 판정

| 등급 | 점수 범위 | 의미 |
|------|-----------|------|
| Strong Buy | 80-100 | 강력 매수 |
| Buy | 60-79 | 매수 |
| Hold | 40-59 | 보유/관망 |
| Sell | 20-39 | 매도 |
| Strong Sell | 0-19 | 강력 매도 |

### 세부 점수 계산 예시

**추세 점수 (MA20/MA60 기준)**
```python
diff_pct = (MA20 - MA60) / MA60 * 100
if diff_pct >= 5:  return 10.0  # 강한 상승
if diff_pct >= 2:  return 8.0   # 상승
if diff_pct >= 0:  return 6.0   # 횡보
if diff_pct >= -2: return 4.0   # 약한 하락
if diff_pct >= -5: return 2.0   # 하락
return 0.0                      # 강한 하락
```

**지지/저항 점수 (52주 범위 기준)**
```python
position = (현재가 - 52주최저) / (52주최고 - 52주최저)
if position <= 0.2: return 10.0  # 바닥권 (매수 기회)
if position <= 0.4: return 8.0   # 저점 근처
if position <= 0.6: return 6.0   # 중간
if position <= 0.8: return 4.0   # 고점 근처
return 2.0                       # 천장권 (주의)
```

## 캐시 시스템

### 캐시 전략

```
CacheManager
    │
    ├── TTL 기반 만료
    │   ├── PRICE: 4시간 (장중 데이터)
    │   ├── MARKET_CAP: 24시간
    │   ├── SUPPLY: 24시간
    │   └── FUNDAMENTAL: 7일
    │
    ├── JSON 파일 기반
    │   └── output/data/cache/*.json
    │
    └── 패턴 매칭 삭제
        └── cache.clear("market_cap_*")
```

### 캐시 파일 구조

```json
{
  "data": { /* 실제 데이터 */ },
  "created_at": "2025-01-17T12:00:00",
  "expires_at": "2025-01-18T12:00:00"
}
```

## 확장 계획

### Phase 3 (대기 중)
- Orchestrator 구현
- 전체 파이프라인 연결
- CLI 인터페이스

### Phase 4 (완료)
- StockReportAgent: 개별 종목 마크다운 리포트
- SectorReportAgent: 섹터 분석 마크다운 리포트
- SummaryAgent: 종합 리포트 및 JSON 데이터

### Phase 5 (계획)
- 웹 대시보드
- 알림 시스템
- 백테스팅 엔진
- 포트폴리오 최적화

## 디렉토리 구조

```
src/
├── core/                        # 핵심 모듈
│   ├── config.py                # 전역 설정 (11개 섹터, RUBRIC_WEIGHTS V2)
│   ├── rubric.py                # 루브릭 엔진 V2 (6개 카테고리)
│   └── orchestrator.py          # (미구현) 파이프라인 조율
│
├── data/                        # 데이터 계층
│   ├── fetcher.py               # 데이터 수집
│   └── cache.py                 # 캐시 관리
│
├── agents/                      # 에이전트 계층
│   ├── base_agent.py            # 추상 기반 클래스
│   │
│   ├── data/                    # 데이터 수집 에이전트
│   │   ├── market_data_agent.py   # 시장 데이터 수집
│   │   ├── fundamental_agent.py   # 재무제표 수집
│   │   └── news_agent.py          # 뉴스/센티먼트 수집
│   │
│   ├── analysis/                # 분석 에이전트
│   │   ├── stock_analyzer.py      # 개별 종목 루브릭 점수
│   │   ├── sector_analyzer.py     # 섹터 시가총액 가중 평균
│   │   └── ranking_agent.py       # 4개 그룹 순위, 최종 18개, Top 3
│   │
│   └── report/                  # 리포트 에이전트
│       ├── __init__.py
│       ├── stock_report_agent.py   # 개별 종목 마크다운 리포트
│       ├── sector_report_agent.py  # 섹터 분석 마크다운 리포트
│       └── summary_agent.py        # 종합 리포트 및 JSON 데이터
│
└── output/                      # 출력
    ├── data/cache/              # 캐시 저장소
    └── reports/                 # 리포트 저장소
        ├── sectors/             # 섹터별 리포트
        ├── stocks/              # 종목별 리포트
        └── summary/             # 요약 리포트

tests/                           # 테스트 (279개)
├── core/                        # rubric V1, V2 테스트 (166개)
├── agents/
│   ├── data/                    # 데이터 에이전트 테스트 (64개)
│   └── analysis/                # 분석 에이전트 테스트 (49개)
```
