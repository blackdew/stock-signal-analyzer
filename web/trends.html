<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>종목 추이 분석 - 주식 신호 분석</title>
    <script>
        var cacheBuster = new Date().toISOString().slice(0, 16).replace(/[-:T]/g, '');
        document.write('<link rel="stylesheet" href="static/css/style.css?t=' + cacheBuster + '">');
        document.write('<script src="static/js/navigation.js?t=' + cacheBuster + '"><\/script>');
    </script>
    <script>
        // 네비게이션 렌더링
        document.addEventListener('DOMContentLoaded', function() {
            renderNavigation('trends');
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 네비게이션 -->
        <nav class="navigation"></nav>

        <!-- 헤더 -->
        <header class="header">
            <h1>종목별 추이 분석</h1>
            <div class="header-info">
                <select id="symbol-select" onchange="loadTrends()">
                    <option value="">종목을 선택하세요</option>
                </select>
                <select id="limit-select" onchange="loadTrends()">
                    <option value="10">최근 10개</option>
                    <option value="20">최근 20개</option>
                    <option value="30" selected>최근 30개</option>
                    <option value="60">최근 60개</option>
                </select>
                <button id="refresh-btn" onclick="loadSymbols()">새로고침</button>
            </div>
        </header>

        <!-- 로딩 상태 -->
        <div id="loading" class="loading">종목 목록을 불러오는 중...</div>

        <!-- 종목 정보 -->
        <section id="stock-info" class="portfolio-summary" style="display: none;">
            <h2 id="stock-title">종목 정보</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-label">현재가</div>
                    <div class="card-value" id="current-price">-</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">최근 매수 점수</div>
                    <div class="card-value" id="latest-buy-score">-</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">최근 매도 점수</div>
                    <div class="card-value" id="latest-sell-score">-</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">최근 액션</div>
                    <div class="card-value" id="latest-action">-</div>
                </div>
                <div class="summary-card">
                    <div class="card-label">수익률</div>
                    <div class="card-value" id="latest-profit-rate">-</div>
                </div>
            </div>
        </section>

        <!-- 차트 섹션 -->
        <section id="charts-section" style="display: none;">
            <h2>가격 및 점수 추이</h2>

            <!-- 가격 차트 -->
            <div class="chart-box">
                <h3>가격 추이</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>

            <!-- 매수/매도 점수 차트 -->
            <div class="chart-box">
                <h3>매수/매도 신호 점수 추이</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="score-chart"></canvas>
                </div>
            </div>

            <!-- 시장 조정 점수 차트 -->
            <div class="chart-box">
                <h3>시장 조정 점수 추이</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="adjusted-score-chart"></canvas>
                </div>
            </div>

            <!-- 수익률 차트 (있는 경우) -->
            <div id="profit-chart-box" class="chart-box" style="display: none;">
                <h3>수익률 추이</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="profit-chart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <script>
        let charts = {};
        let trendsData = null;

        // 종목 목록 불러오기
        async function loadSymbols() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.textContent = '종목 목록을 불러오는 중...';

            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/symbols?t=${timestamp}`);
                if (!response.ok) {
                    throw new Error('종목 목록을 불러올 수 없습니다.');
                }

                const symbols = await response.json();
                renderSymbolSelect(symbols);

                loading.style.display = 'none';
            } catch (error) {
                loading.innerHTML = `<div class="error-card">종목 목록을 불러오는데 실패했습니다.<br>${error.message}</div>`;
            }
        }

        // 종목 선택 박스 렌더링
        function renderSymbolSelect(symbols) {
            const select = document.getElementById('symbol-select');
            select.innerHTML = '<option value="">종목을 선택하세요</option>' +
                symbols.map(s => `<option value="${s.symbol}">${s.name} (${s.symbol})</option>`).join('');

            // 첫 번째 종목을 자동으로 선택
            if (symbols.length > 0) {
                // DOM 업데이트 후 실행되도록 setTimeout 사용
                setTimeout(() => {
                    select.value = symbols[0].symbol;
                    loadTrends();
                }, 100);
            }
        }

        // 추이 데이터 불러오기
        async function loadTrends() {
            const symbol = document.getElementById('symbol-select').value;
            const limit = document.getElementById('limit-select').value;

            if (!symbol) {
                return;
            }

            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.textContent = '추이 데이터를 불러오는 중...';

            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/trends?symbol=${symbol}&limit=${limit}&t=${timestamp}`);
                if (!response.ok) {
                    throw new Error('추이 데이터를 불러올 수 없습니다.');
                }

                trendsData = await response.json();
                renderTrends();
            } catch (error) {
                loading.innerHTML = `<div class="error-card">추이 데이터를 불러오는데 실패했습니다.<br>${error.message}</div>`;
            }
        }

        // 추이 데이터 렌더링
        function renderTrends() {
            document.getElementById('loading').style.display = 'none';

            if (!trendsData || trendsData.data.length === 0) {
                document.getElementById('loading').innerHTML = '<div class="error-card">해당 종목의 데이터가 없습니다.</div>';
                document.getElementById('loading').style.display = 'block';
                return;
            }

            // 종목 정보 표시
            renderStockInfo();

            // 차트 렌더링
            renderPriceChart();
            renderScoreChart();
            renderAdjustedScoreChart();
            renderProfitChart();

            document.getElementById('stock-info').style.display = 'block';
            document.getElementById('charts-section').style.display = 'block';
        }

        // 종목 정보 렌더링
        function renderStockInfo() {
            const latest = trendsData.data[trendsData.data.length - 1];

            document.getElementById('stock-title').textContent = `${trendsData.name} (${trendsData.symbol})`;
            document.getElementById('current-price').textContent = formatPrice(latest.price);
            document.getElementById('latest-buy-score').textContent = latest.buy_score + '점';
            document.getElementById('latest-sell-score').textContent = latest.sell_score + '점';

            const actionElement = document.getElementById('latest-action');
            actionElement.textContent = latest.action === 'BUY' ? '매수' : latest.action === 'SELL' ? '매도' : '관망';
            actionElement.className = 'card-value action-' + latest.action.toLowerCase();

            const profitElement = document.getElementById('latest-profit-rate');
            if (latest.profit_rate !== null) {
                profitElement.textContent = formatPercentage(latest.profit_rate * 100);
                profitElement.className = 'card-value ' + (latest.profit_rate >= 0 ? 'positive' : 'negative');
            } else {
                profitElement.textContent = '-';
                profitElement.className = 'card-value';
            }
        }

        // 가격 차트
        function renderPriceChart() {
            const ctx = document.getElementById('price-chart');
            if (charts.price) charts.price.destroy();

            const dates = trendsData.data.map(d => formatDate(d.date));
            const prices = trendsData.data.map(d => d.price);

            charts.price = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '주가',
                        data: prices,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: getChartOptions('원', formatPrice)
            });
        }

        // 매수/매도 점수 차트
        function renderScoreChart() {
            const ctx = document.getElementById('score-chart');
            if (charts.score) charts.score.destroy();

            const dates = trendsData.data.map(d => formatDate(d.date));
            const buyScores = trendsData.data.map(d => d.buy_score);
            const sellScores = trendsData.data.map(d => d.sell_score);

            charts.score = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '매수 점수',
                            data: buyScores,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '매도 점수',
                            data: sellScores,
                            borderColor: '#F44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: getChartOptions('점', (val) => val.toFixed(0))
            });
        }

        // 시장 조정 점수 차트
        function renderAdjustedScoreChart() {
            const ctx = document.getElementById('adjusted-score-chart');
            if (charts.adjusted) charts.adjusted.destroy();

            const dates = trendsData.data.map(d => formatDate(d.date));
            const buyAdjusted = trendsData.data.map(d => d.buy_adjusted_score);
            const sellAdjusted = trendsData.data.map(d => d.sell_adjusted_score);

            charts.adjusted = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '조정 매수 점수',
                            data: buyAdjusted,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '조정 매도 점수',
                            data: sellAdjusted,
                            borderColor: '#F44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: getChartOptions('점', (val) => val.toFixed(0))
            });
        }

        // 수익률 차트
        function renderProfitChart() {
            const profitData = trendsData.data.filter(d => d.profit_rate !== null);

            if (profitData.length === 0) {
                document.getElementById('profit-chart-box').style.display = 'none';
                return;
            }

            document.getElementById('profit-chart-box').style.display = 'block';

            const ctx = document.getElementById('profit-chart');
            if (charts.profit) charts.profit.destroy();

            const dates = profitData.map(d => formatDate(d.date));
            const profits = profitData.map(d => d.profit_rate * 100);

            charts.profit = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '수익률',
                        data: profits,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: getChartOptions('%', (val) => val.toFixed(2) + '%')
            });
        }

        // 차트 옵션 생성
        function getChartOptions(unit, formatter) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatter(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        display: true,
                        ticks: {
                            callback: formatter
                        }
                    }
                }
            };
        }

        // 유틸리티 함수
        function formatPrice(price) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(price);
        }

        function formatPercentage(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit'
            });
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', loadSymbols);
    </script>
</body>
</html>
